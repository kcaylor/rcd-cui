#!/usr/bin/env bash
set -euo pipefail

if [ "$#" -lt 1 ]; then
  echo "Usage: sanitize_node.sh <device> [clear|purge]" >&2
  exit 2
fi

DEVICE="$1"
METHOD="${2:-clear}"
LOG_FILE="{{ hpc_node_lifecycle_log_dir }}/sanitize_node.log"

if [ ! -b "${DEVICE}" ]; then
  echo "Target device ${DEVICE} is not a block device" >&2
  exit 1
fi

mkdir -p "{{ hpc_node_lifecycle_log_dir }}"

echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] Sanitizing ${DEVICE} using method ${METHOD}" >> "${LOG_FILE}"

if [ "${METHOD}" = "purge" ] && command -v blkdiscard >/dev/null 2>&1; then
  blkdiscard -f "${DEVICE}"
else
  dd if=/dev/zero of="${DEVICE}" bs=16M status=progress oflag=direct
fi

# Verification step required for auditable completion.
verify_sample="$(dd if="${DEVICE}" bs=1M count=1 2>/dev/null | tr -d '\\000')"
if [ -n "${verify_sample}" ]; then
  echo "Verification failed: non-zero sample remains" >> "${LOG_FILE}"
  exit 1
fi

echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] Sanitization verified for ${DEVICE}" >> "${LOG_FILE}"
exit 0
