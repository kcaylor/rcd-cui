---
- name: Check SSH root login setting
  ansible.builtin.command: grep -E '^PermitRootLogin' /etc/ssh/sshd_config
  register: compliance_gate_ssh
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: Check auditd service state
  ansible.builtin.command: systemctl is-active auditd
  register: compliance_gate_auditd
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: Check /etc/shadow permissions
  ansible.builtin.command: stat -c %a /etc/shadow
  register: compliance_gate_shadow
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: Check firewalld service state
  ansible.builtin.command: systemctl is-active firewalld
  register: compliance_gate_firewall
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: Gate node join on compliance checks
  ansible.builtin.assert:
    that:
      - "'PermitRootLogin no' in (compliance_gate_ssh.stdout | default(''))"
      - "(compliance_gate_auditd.stdout | default('unknown')) == 'active'"
      - "(compliance_gate_shadow.stdout | default('999')) == '000'"
      - "(compliance_gate_firewall.stdout | default('unknown')) == 'active'"
    fail_msg: "Compliance gate failed for node {{ inventory_hostname }}"
    success_msg: "Compliance gate passed for node {{ inventory_hostname }}"
  tags:
    - verify
