---
# WHY: Fail fast if zone context is missing so this control is never applied ambiguously.
- name: Validate CUI zone assignment for ia_freeipa_client
  ansible.builtin.include_role:
    name: common
    tasks_from: validate_zone.yml
  tags: &role_tags
    - r2_3.5.1
    - r3_03.05.01
    - family_IA
    - zone_{{ cui_zone }}

# WHY: Install required software components that provide this security capability.
- name: Install required packages for ia_freeipa_client
  ansible.builtin.package:
    name: "{{ ia_freeipa_client_packages }}"
    state: present
  when:
    - ia_freeipa_client_enabled | bool
    - ia_freeipa_client_packages | length > 0
  tags: *role_tags

# WHY: Deploy controlled configuration from versioned templates for repeatable compliance state.
- name: Deploy configuration templates for ia_freeipa_client
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0644') }}"
    validate: "{{ item.validate | default(omit) }}"
  loop: "{{ ia_freeipa_client_templates }}"
  notify: Restart ia_freeipa_client services
  when:
    - ia_freeipa_client_enabled | bool
    - ia_freeipa_client_templates | length > 0
  tags: *role_tags

# WHY: Place supporting helper scripts and policy files needed by this control implementation.
- name: Deploy static helper files for ia_freeipa_client
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0644') }}"
  loop: "{{ ia_freeipa_client_files }}"
  notify: Restart ia_freeipa_client services
  when:
    - ia_freeipa_client_enabled | bool
    - ia_freeipa_client_files | length > 0
  tags: *role_tags

# WHY: Ensure security services are continuously enforced after configuration changes.
- name: Ensure managed services are enabled and running for ia_freeipa_client
  ansible.builtin.systemd:
    name: "{{ item.name }}"
    enabled: "{{ item.enabled }}"
    state: "{{ item.state }}"
  loop: "{{ ia_freeipa_client_services }}"
  when:
    - ia_freeipa_client_enabled | bool
    - ia_freeipa_client_services | length > 0
  tags: *role_tags

# WHY: Mark verify-only controls so implementation runs are explicit and auditable.
- name: Report verify-only mode for ia_freeipa_client when no stateful tasks apply
  ansible.builtin.debug:
    msg: "ia_freeipa_client is configured as verify-heavy for this host and made no direct changes."
  changed_when: false
  when:
    - ia_freeipa_client_enabled | bool
    - ia_freeipa_client_packages | length == 0
    - ia_freeipa_client_templates | length == 0
    - ia_freeipa_client_files | length == 0
    - ia_freeipa_client_services | length == 0
  tags: *role_tags

# WHY: Join the host to centralized identity services to enforce enterprise account policy.
- name: Enroll host with FreeIPA
  ansible.builtin.command: >-
    ipa-client-install --unattended --mkhomedir --domain={{ freeipa_domain }}
    --realm={{ freeipa_realm }} --server={{ freeipa_servers | first }}
  register: ia_freeipa_client_enroll_result
  changed_when: ia_freeipa_client_enroll_result.rc == 0
  failed_when: ia_freeipa_client_enroll_result.rc not in [0, 3]
  when:
    - ia_freeipa_client_enabled | bool
    - not ansible_check_mode
  tags: *role_tags
