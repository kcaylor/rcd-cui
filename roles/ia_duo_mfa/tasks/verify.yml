---
# WHY: Re-validate zone context during read-only audits to keep evidence attributable by zone.
- name: Validate CUI zone assignment for ia_duo_mfa verification
  ansible.builtin.include_role:
    name: common
    tasks_from: validate_zone.yml
  tags: &role_verify_tags
    - r2_3.5.3
    - r3_03.05.03
    - family_IA
    - zone_{{ cui_zone }}

# WHY: Run non-destructive checks that show whether controls are active without modifying state.
- name: Execute compliance verification checks for ia_duo_mfa
  ansible.builtin.command: "{{ item.command }}"
  loop: "{{ ia_duo_mfa_verify_commands }}"
  loop_control:
    label: "{{ item.id }}"
  register: ia_duo_mfa_verify_results
  changed_when: false
  failed_when: false
  check_mode: false
  when: ia_duo_mfa_verify_commands | length > 0
  tags: *role_verify_tags

# WHY: Store structured verification output so auditors can trace check outcomes.
- name: Build verification summary for ia_duo_mfa
  ansible.builtin.set_fact:
    ia_duo_mfa_verify_summary:
      role: ia_duo_mfa
      zone: "{{ cui_zone }}"
      compliant: >-
        {{ (ia_duo_mfa_verify_results.results | default([]) |
        selectattr('rc', 'equalto', 0) | list | length) ==
        (ia_duo_mfa_verify_commands | length) }}
      checks: "{{ ia_duo_mfa_verify_results.results | default([]) }}"
  changed_when: false
  tags: *role_verify_tags

# WHY: Print verification status in plain language for operators and compliance staff.
- name: Show verification summary for ia_duo_mfa
  ansible.builtin.debug:
    var: ia_duo_mfa_verify_summary
  changed_when: false
  tags: *role_verify_tags
