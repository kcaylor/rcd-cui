---
- name: Validate CUI zone assignment for hpc_storage_security verification
  ansible.builtin.include_role:
    name: common
    tasks_from: validate_zone.yml
  tags: &hpc_storage_security_verify_tags
    - r2_3.1.3
    - r2_3.8.3
    - r3_03.01.03
    - r3_03.08.03
    - family_HPC
    - zone_{{ cui_zone }}

- name: Execute hpc_storage_security verification commands
  ansible.builtin.command: "{{ item.command }}"
  loop: "{{ hpc_storage_security_verify_commands }}"
  loop_control:
    label: "{{ item.id }}"
  register: hpc_storage_security_verify_results
  changed_when: false
  failed_when: false
  check_mode: false
  when: hpc_storage_security_verify_commands | length > 0
  tags: *hpc_storage_security_verify_tags

- name: Verify project ACL and quota markers for each project directory
  ansible.builtin.shell: |
    set -euo pipefail
    for dir in {{ hpc_storage_security_project_root }}/*; do
      [ -d "$dir" ] || continue
      getfacl "$dir" >/dev/null
      test -f "$dir/{{ hpc_storage_security_quota_readonly_flag }}" || true
    done
  args:
    executable: /bin/bash
  register: hpc_storage_security_acl_quota_verify
  changed_when: false
  failed_when: false
  check_mode: false
  tags: *hpc_storage_security_verify_tags

- name: Build hpc_storage_security verification summary
  ansible.builtin.set_fact:
    hpc_storage_security_verify_summary:
      role: hpc_storage_security
      zone: "{{ cui_zone }}"
      compliant: >-
        {{
          (hpc_storage_security_verify_results.results | default([])
          | selectattr('rc', 'equalto', 0) | list | length)
          == (hpc_storage_security_verify_commands | length)
        }}
      checks: "{{ hpc_storage_security_verify_results.results | default([]) }}"
      acl_quota_check: "{{ hpc_storage_security_acl_quota_verify.rc | default(1) == 0 }}"
  changed_when: false
  tags: *hpc_storage_security_verify_tags

- name: Show hpc_storage_security verification summary
  ansible.builtin.debug:
    var: hpc_storage_security_verify_summary
  changed_when: false
  tags: *hpc_storage_security_verify_tags
