---
- name: Validate CUI zone assignment for hpc_slurm_cui evidence collection
  ansible.builtin.include_role:
    name: common
    tasks_from: validate_zone.yml
  tags: &hpc_slurm_cui_evidence_tags
    - r2_3.3.1
    - r2_3.3.2
    - r3_03.03.01
    - r3_03.03.02
    - family_HPC
    - zone_{{ cui_zone }}

- name: Ensure host evidence directory exists for hpc_slurm_cui
  ansible.builtin.file:
    path: "{{ (evidence_output_dir | default('/tmp/cui-evidence')) ~ '/' ~ inventory_hostname }}"
    state: directory
    owner: root
    group: root
    mode: '0750'
  tags: *hpc_slurm_cui_evidence_tags

- name: Collect hpc_slurm_cui evidence file metadata
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ hpc_slurm_cui_evidence_files }}"
  register: hpc_slurm_cui_evidence_file_stats
  changed_when: false
  when: hpc_slurm_cui_evidence_files | length > 0
  tags: *hpc_slurm_cui_evidence_tags

- name: Collect hpc_slurm_cui evidence command outputs
  ansible.builtin.command: "{{ item.command }}"
  loop: "{{ hpc_slurm_cui_evidence_commands }}"
  loop_control:
    label: "{{ item.id }}"
  register: hpc_slurm_cui_evidence_command_results
  changed_when: false
  failed_when: false
  check_mode: false
  when: hpc_slurm_cui_evidence_commands | length > 0
  tags: *hpc_slurm_cui_evidence_tags

- name: Build hpc_slurm_cui evidence payload
  ansible.builtin.set_fact:
    hpc_slurm_cui_evidence_payload:
      role: hpc_slurm_cui
      host: "{{ inventory_hostname }}"
      zone: "{{ cui_zone }}"
      file_stats: "{{ hpc_slurm_cui_evidence_file_stats.results | default([]) }}"
      command_results: "{{ hpc_slurm_cui_evidence_command_results.results | default([]) }}"
  changed_when: false
  tags: *hpc_slurm_cui_evidence_tags

- name: Write hpc_slurm_cui evidence payload
  ansible.builtin.copy:
    dest: "{{ (evidence_output_dir | default('/tmp/cui-evidence')) ~ '/' ~ inventory_hostname ~ '/hpc_slurm_cui_evidence.json' }}"
    owner: root
    group: root
    mode: '0640'
    content: "{{ hpc_slurm_cui_evidence_payload | to_nice_json }}"
  tags: *hpc_slurm_cui_evidence_tags
